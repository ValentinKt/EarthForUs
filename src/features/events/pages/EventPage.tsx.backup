import * as React
import { useEffect, useState } from 'react';
import { Link, useParams } from 'react-router-dom';
import Button from '../../../shared/ui/Button';
import { useToast } from '../../../shared/components/Toast';
import { logger } from '../../../shared/utils/logger';
import { api } from '../../../shared/utils/api';
import EventMap from '../components/EventMap';
import ChatComponent from '../components/ChatComponent';
import TodoListComponent from '../components/TodoListComponent';
import { useAuth } from '../../auth/context/AuthContext';

type EventDetail = {
  id: number;
  title: string;
  description?: string | null;
  location?: string | null;
  start_time: string;
  end_time: string;
  capacity?: number | null;
};

const tabs = [
  { id: 'about', label: 'About' },
  { id: 'updates', label: 'Updates' },
  { id: 'checklist', label: 'Checklist' },
  { id: 'chat', label: 'Chat' },
  { id: 'map', label: 'Map' },
];

const EventPage: React.FC = () => {
  const { id } = useParams();
  const [event, setEvent] = useState<EventDetail | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [activeTab, setActiveTab] = useState<string>('about');
  const { success: showSuccess, error: showError } = useToast();
  const log = logger.withContext('EventPage');
  const { user } = useAuth();
  const [isJoining, setIsJoining] = useState(false);
  const [hasJoined, setHasJoined] = useState(false);

  const onJoin = async () => {
    if (!event?.id) return;
    if (!user?.id) {
      showError('Please log in to join the event', 'Join Failed');
      return;
    }
    if (isJoining || hasJoined) return;
    setIsJoining(true);
    try {
      const res = await api.post(`/api/events/${event?.id}/join`, { user_id: user.id });
      if ((res as any)?.status === 'already_registered') {
        setHasJoined(true);
        showSuccess('You are already registered for this event', 'Joined');
        log.info('already_registered', { eventId: event?.id });
        return;
      }
      setHasJoined(true);
      showSuccess('Joined the event successfully', 'Joined');
      log.info('join_success', { eventId: event?.id });
    } catch (e) {
      const msg = (e as Error)?.message || 'Failed to join event';
      showError(msg, 'Join Failed');
      log.error('join_error', { eventId: event?.id, message: msg });
    } finally {
      setIsJoining(false);
    }
  };

  useEffect(() => {
    const fetchEvent = async () => {
      if (!id) return;
      setIsLoading(true);
      setError(null);
      const grp = log.group('fetch_event');
      const tm = log.time('fetch');
      try {
        const data = await api.get<EventDetail>(`/api/events/${id}`);
        setEvent(data);
        log.info('fetch_success', { id });
      } catch (e) {
        // Fallback: fetch list and select by id if detail endpoint is unavailable
        try {
          const list = await api.get<{ events: EventDetail[] }>(`/api/events`);
          const found = (list?.events || []).find(ev => String(ev.id) === String(id));
          if (found) {
            setEvent(found);
            log.warn('detail_unavailable_used_list_fallback', { id });
          } else {
            const msg = (e as Error)?.message || 'Failed to load event';
            log.error('fetch_error', { message: msg, id });
            setError(msg);
            showError(msg, 'Event Load Error');
          }
        } catch (e2) {
          const msg = (e as Error)?.message || 'Failed to load event';
          log.error('fetch_error', { message: msg, id });
          setError(msg);
          showError(msg, 'Event Load Error');
        }
      } finally {
        tm.end();
        grp.end();
        setIsLoading(false);
      }
    };
    fetchEvent();
  }, [id]);

  const metaItem = (icon: React.ReactNode, label: string) => (
    <div className="flex items-center gap-2 text-sm text-gray-700">
      {icon}
      <span>{label}</span>
    </div>
  );

  return (
    <div className="content-wrapper">
      {/* Top Bar */}
      <div className="sticky top-0 z-10 flex items-center justify-between bg-white/80 backdrop-blur-sm p-4 border-b border-gray-200">
        <Link to="/events" className="text-gray-700 flex items-center gap-2 rounded-xl px-3 py-2 hover:bg-gray-100">
          <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" /></svg>
          <span>Back to events</span>
        </Link>
        <h1 className="text-lg font-bold tracking-tight">Event Details</h1>
        <div className="flex items-center gap-2">
          <Button variant="earth" onClick={onJoin} disabled={isJoining || hasJoined} loading={isJoining}>{hasJoined ? 'Joined' : 'Join'}</Button>
        </div>
      </div>

      {/* Loading State */}
      {isLoading && (
        <div className="max-w-4xl mx-auto px-4 py-6">
          <div className="h-8 w-1/2 bg-gray-200 animate-pulse rounded mb-4" />
          <div className="h-5 w-1/3 bg-gray-200 animate-pulse rounded mb-6" />
          <div className="h-40 bg-gray-200 animate-pulse rounded" />
        </div>
      )}

      {/* Error State */}
      {!isLoading && error && (
        <div className="max-w-4xl mx-auto px-4 py-6 space-y-4">
          <div className="rounded-xl border border-red-200 bg-red-50 p-4 text-red-700 flex items-center justify-between">
            <span>{error}</span>
            <Button variant="earth" onClick={() => window.location.reload()}>Retry</Button>
          </div>
          <div className="rounded-xl border border-gray-200 bg-white p-4">
            <h3 className="text-lg font-semibold mb-2">Try the map</h3>
            <p className="text-sm text-gray-600 mb-3">Explore location and radius controls even if event data is unavailable.</p>
            <EventMap radius={500} minRadius={100} maxRadius={5000} />
          </div>
        </div>
      )}

      {/* Content */}
      {!isLoading && !error && (
        <div className="max-w-4xl mx-auto px-4 py-6">
          {/* Header */}
          <div className="mb-4">
            <h2 className="text-2xl font-bold tracking-tight text-gray-900 dark:text-white">{event?.title || 'Untitled Event'}</h2>
            <div className="mt-2 flex flex-wrap gap-4">
              {metaItem(
                <svg className="w-4 h-4 text-gray-500 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3M3 11h18M5 19h14"/></svg>,
                new Date(event?.start_time || Date.now()).toLocaleString()
              )}
              {metaItem(
                <svg className="w-4 h-4 text-gray-500 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 16l4-4m0 0l-4-4m4 4H7"/></svg>,
                new Date(event?.end_time || Date.now()).toLocaleString()
              )}
              {metaItem(
                <svg className="w-4 h-4 text-gray-500 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17.657 16.657L13.414 12.414m0 0L9.172 8.172m4.242 4.242l4.243 4.243M9.172 8.172l4.243 4.243"/></svg>,
                event?.location || 'Location TBA'
              )}
              {typeof event?.capacity === 'number' && metaItem(
                <svg className="w-4 h-4 text-gray-500 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 20h5v-2a3 3 0 00-5.356-1.857M9 20H4v-2a3 3 0 015.356-1.857M18 8a3 3 0 11-6 0 3 3 0 016 0zM6 8a3 3 0 11-6 0 3 3 0 016 0z"/></svg>,
                `${event.capacity} volunteers`
              )}
            </div>
          </div>

          {/* Tabs */}
          <div className="border-b border-gray-200 dark:border-gray-800">
            <nav className="-mb-px flex flex-wrap gap-2" aria-label="Event sections">
              {tabs.map(t => (
                <button
                  key={t.id}
                  onClick={() => setActiveTab(t.id)}
                  className={`px-4 py-2 border-b-2 ${activeTab === t.id ? 'border-brand-600 text-brand-700' : 'border-transparent text-gray-600 dark:text-gray-300 hover:text-gray-800 dark:hover:text-gray-200 hover:border-gray-300 dark:hover:border-gray-700'} transition-colors`}
                  aria-current={activeTab === t.id ? 'page' : undefined}
                >
                  {t.label}
                </button>
              ))}
            </nav>
          </div>

          {/* Tab Content */}
          <div className="mt-6">
            {activeTab === 'about' && (
              <div className="prose max-w-none">
                <p className="text-gray-700 dark:text-gray-200">{event?.description || 'No description provided for this event yet.'}</p>
              </div>
            )}
            {activeTab === 'updates' && (
              <div className="rounded-xl border border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900 p-4 text-gray-700 dark:text-gray-200">
                <p>No updates yet. Organizers can post plans and progress here.</p>
              </div>
            )}
            {activeTab === 'checklist' && (
              <TodoListComponent 
                eventId={event?.id || 0}
                currentUserId={1} // TODO: Get from auth context
                currentUserName="Current User" // TODO: Get from auth context
                isOrganizer={true} // TODO: Determine based on user role
              />
            )}
            {activeTab === 'chat' && (
              <ChatComponent 
                eventId={event?.id || 0}
                currentUserId={1} // TODO: Get from auth context
                currentUserName="Current User" // TODO: Get from auth context
              />
            )}
            {activeTab === 'map' && (
              <div className="space-y-3">
                <div className="rounded-xl border border-gray-200 bg-white p-4">
                  <EventMap
                    address={event?.location || undefined}
                    radius={500}
                    minRadius={100}
                    maxRadius={5000}
                  />
                </div>
              </div>
            )}
          </div>
        </div>
      )}
    </div>
  );
};

export default EventPage;
